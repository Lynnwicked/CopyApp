using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;

namespace PlexApp.Plex {
  public class Importer {
    private readonly PlexArgs _args;

    #region Audio Extensions

    private readonly List<string> _audioExtensions = new List<string> {
      ".3ga",
      ".4mp",
      ".5xb",
      ".5xe",
      ".5xs",
      ".669",
      ".8svx",
      ".a2b",
      ".a2i",
      ".a2m",
      ".aa",
      ".aa3",
      ".aac",
      ".aax",
      ".ab",
      ".abc",
      ".abm",
      ".ac3",
      ".acd",
      ".acd-bak",
      ".acd-zip",
      ".acm",
      ".acp",
      ".act",
      ".adg",
      ".adt",
      ".adts",
      ".adv",
      ".afc",
      ".agm",
      ".agr",
      ".aif",
      ".aifc",
      ".aiff",
      ".aimppl",
      ".akp",
      ".alc",
      ".all",
      ".als",
      ".amf",
      ".amr",
      ".ams",
      ".ams",
      ".amxd",
      ".amz",
      ".ang",
      ".aob",
      ".ape",
      ".apl",
      ".aria",
      ".ariax",
      ".asd",
      ".at3",
      ".au",
      ".aud",
      ".aup",
      ".avastsounds",
      ".ay",
      ".b4s",
      ".band",
      ".bap",
      ".bdd",
      ".bidule",
      ".bnk",
      ".brstm",
      ".bun",
      ".bwf",
      ".bwg",
      ".bww",
      ".caf",
      ".caff",
      ".cda",
      ".cdda",
      ".cdlx",
      ".cdo",
      ".cdr",
      ".cel",
      ".cfa",
      ".cgrp",
      ".cidb",
      ".ckb",
      ".ckf",
      ".conform",
      ".copy",
      ".cpr",
      ".cpt",
      ".csh",
      ".cts",
      ".cwb",
      ".cwp",
      ".cws",
      ".cwt",
      ".dcf",
      ".dcm",
      ".dct",
      ".dewf",
      ".df2",
      ".dfc",
      ".dff",
      ".dig",
      ".dig",
      ".dls",
      ".dm",
      ".dmc",
      ".dmf",
      ".dmsa",
      ".dmse",
      ".dra",
      ".drg",
      ".ds",
      ".ds2",
      ".dsf",
      ".dsm",
      ".dss",
      ".dtm",
      ".dts",
      ".dtshd",
      ".dvf",
      ".dwd",
      ".efa",
      ".efe",
      ".efk",
      ".efq",
      ".efs",
      ".efv",
      ".emd",
      ".emp",
      ".emx",
      ".esps",
      ".expressionmap",
      ".exs",
      ".f2r",
      ".f32",
      ".f3r",
      ".f4a",
      ".f64",
      ".fdp",
      ".fev",
      ".flac",
      ".flm",
      ".flp",
      ".flp",
      ".fpa",
      ".frg",
      ".fsb",
      ".fsc",
      ".fsm",
      ".ftm",
      ".ftm",
      ".ftmx",
      ".fzf",
      ".fzv",
      ".g721",
      ".g723",
      ".g726",
      ".gbproj",
      ".gbs",
      ".gig",
      ".gp5",
      ".gpbank",
      ".gpk",
      ".gpx",
      ".groove",
      ".gsf",
      ".gsflib",
      ".gsm",
      ".h0",
      ".h4b",
      ".h5b",
      ".h5e",
      ".h5s",
      ".hbe",
      ".hdp",
      ".hma",
      ".hsb",
      ".iaa",
      ".ics",
      ".iff",
      ".igp",
      ".igr",
      ".imp",
      ".ins",
      ".ins",
      ".isma",
      ".iti",
      ".itls",
      ".its",
      ".jam",
      ".jspf",
      ".k26",
      ".kar",
      ".kfn",
      ".kmp",
      ".koz",
      ".koz",
      ".kpl",
      ".krz",
      ".ksc",
      ".ksf",
      ".kt3",
      ".l",
      ".la",
      ".lof",
      ".logic",
      ".logicx",
      ".lso",
      ".lwv",
      ".m3u",
      ".m3u8",
      ".m4a",
      ".m4b",
      ".m4p",
      ".m4r",
      ".m5p",
      ".ma1",
      ".mbr",
      ".mdc",
      ".mdr",
      ".med",
      ".mgv",
      ".mid",
      ".midi",
      ".minigsf",
      ".minipsf",
      ".miniusf",
      ".mka",
      ".mmf",
      ".mmlp",
      ".mmm",
      ".mmp",
      ".mmpz",
      ".mo3",
      ".mod",
      ".mogg",
      ".mp2",
      ".mp3",
      ".mpa",
      ".mpc",
      ".mpdp",
      ".mpga",
      ".mpu",
      ".mscx",
      ".mscz",
      ".msv",
      ".mt2",
      ".mte",
      ".mtf",
      ".mti",
      ".mtm",
      ".mtp",
      ".mts",
      ".mui",
      ".mus",
      ".mus",
      ".mus",
      ".musx",
      ".mux",
      ".mx3",
      ".mx4",
      ".mx5",
      ".mx5template",
      ".mxl",
      ".mxmf",
      ".myr",
      ".narrative",
      ".nbs",
      ".ncw",
      ".nkb",
      ".nkc",
      ".nki",
      ".nkm",
      ".nks",
      ".nkx",
      ".nml",
      ".nmsv",
      ".note",
      ".npl",
      ".nra",
      ".nrt",
      ".nsa",
      ".ntn",
      ".nvf",
      ".nwc",
      ".obw",
      ".odm",
      ".ofr",
      ".oga",
      ".ogg",
      ".okt",
      ".oma",
      ".omf",
      ".omg",
      ".omx",
      ".opus",
      ".ots",
      ".ove",
      ".ovw",
      ".ovw",
      ".pac",
      ".paf",
      ".pandora",
      ".pbf",
      ".pca",
      ".pcast",
      ".pcg",
      ".peak",
      ".pek",
      ".pho",
      ".phy",
      ".pk",
      ".pkf",
      ".pla",
      ".pls",
      ".ply",
      ".pna",
      ".pno",
      ".ppc",
      ".ppcx",
      ".prg",
      ".psf",
      ".psf1",
      ".psf2",
      ".psm",
      ".psy",
      ".ptcop",
      ".ptf",
      ".ptm",
      ".pts",
      ".ptt",
      ".ptx",
      ".ptxt",
      ".pvc",
      ".qcp",
      ".r1m",
      ".ra",
      ".ram",
      ".raw",
      ".rax",
      ".rbs",
      ".rbs",
      ".rcy",
      ".rex",
      ".rfl",
      ".rgrp",
      ".rip",
      ".rmi",
      ".rmj",
      ".rmx",
      ".rng",
      ".rns",
      ".rol",
      ".rsn",
      ".rso",
      ".rta",
      ".rti",
      ".rts",
      ".rvx",
      ".rx2",
      ".s3i",
      ".s3m",
      ".s3z",
      ".saf",
      ".sap",
      ".sbg",
      ".sbi",
      ".sc2",
      ".scs11",
      ".sd",
      ".sd",
      ".sd2",
      ".sd2f",
      ".sdat",
      ".sds",
      ".sdt",
      ".seq",
      ".ses",
      ".sesx",
      ".sf2",
      ".sfap0",
      ".sfk",
      ".sfl",
      ".sfpack",
      ".sfs",
      ".sfz",
      ".sgp",
      ".shn",
      ".sib",
      ".slp",
      ".slx",
      ".sma",
      ".smf",
      ".smp",
      ".smp",
      ".smpx",
      ".snd",
      ".snd",
      ".snd",
      ".sng",
      ".sng",
      ".sns",
      ".song",
      ".sou",
      ".sppack",
      ".sprg",
      ".spx",
      ".sseq",
      ".sseq",
      ".ssm",
      ".ssnd",
      ".stap",
      ".stm",
      ".stx",
      ".sty",
      ".svd",
      ".svx",
      ".swa",
      ".sxt",
      ".syh",
      ".syn",
      ".syw",
      ".syx",
      ".tak",
      ".tak",
      ".td0",
      ".tg",
      ".toc",
      ".trak",
      ".tta",
      ".txw",
      ".u",
      ".uax",
      ".ult",
      ".uni",
      ".usf",
      ".usflib",
      ".ust",
      ".uw",
      ".uwf",
      ".vag",
      ".vap",
      ".vb",
      ".vc3",
      ".vdj",
      ".vgm",
      ".vgz",
      ".vip",
      ".vlc",
      ".vmd",
      ".vmf",
      ".vmf",
      ".vmo",
      ".voc",
      ".vox",
      ".voxal",
      ".vpl",
      ".vpm",
      ".vpw",
      ".vqf",
      ".vrf",
      ".vsq",
      ".vsqx",
      ".vtx",
      ".vyf",
      ".w01",
      ".w64",
      ".wav",
      ".wave",
      ".wax",
      ".wem",
      ".wfb",
      ".wfd",
      ".wfm",
      ".wfp",
      ".wma",
      ".wow",
      ".wpk",
      ".wpp",
      ".wproj",
      ".wrk",
      ".wtpl",
      ".wtpt",
      ".wus",
      ".wut",
      ".wv",
      ".wvc",
      ".wve",
      ".wwu",
      ".xa",
      ".xa",
      ".xfs",
      ".xm",
      ".xmf",
      ".xmu",
      ".xrns",
      ".xsp",
      ".xspf",
      ".yookoo",
      ".zpa",
      ".zpl",
      ".zvd"
    };

    #endregion

    #region Video Extensions

    private readonly List<string> _videoExtensions = new List<string> {
      ".264",
      ".3g2",
      ".3gp",
      ".3gp2",
      ".3gpp",
      ".3gpp2",
      ".3mm",
      ".3p2",
      ".60d",
      ".787",
      ".890",
      ".aaf",
      ".aec",
      ".aecap",
      ".aegraphic",
      ".aep",
      ".aepx",
      ".aet",
      ".aetx",
      ".ajp",
      ".ale",
      ".am",
      ".amc",
      ".amv",
      ".amx",
      ".anim",
      ".anx",
      ".aqt",
      ".arcut",
      ".arf",
      ".asf",
      ".asx",
      ".avb",
      ".avc",
      ".avchd",
      ".avd",
      ".avi",
      ".avm",
      ".avp",
      ".avs",
      ".avs",
      ".avv",
      ".awlive",
      ".axm",
      ".axv",
      ".bdm",
      ".bdmv",
      ".bdt2",
      ".bdt3",
      ".bik",
      ".bin",
      ".bix",
      ".bmc",
      ".bmk",
      ".bnp",
      ".box",
      ".bs4",
      ".bsf",
      ".bu",
      ".bvr",
      ".byu",
      ".camproj",
      ".camrec",
      ".camv",
      ".ced",
      ".cel",
      ".cine",
      ".cip",
      ".clk",
      ".clpi",
      ".cmmp",
      ".cmmtpl",
      ".cmproj",
      ".cmrec",
      ".cmv",
      ".cpi",
      ".cpvc",
      ".crec",
      ".cst",
      ".cvc",
      ".cx3",
      ".d2v",
      ".d3v",
      ".dad",
      ".dash",
      ".dat",
      ".dav",
      ".db2",
      ".dce",
      ".dck",
      ".dcr",
      ".dcr",
      ".ddat",
      ".dif",
      ".dir",
      ".divx",
      ".dlx",
      ".dmb",
      ".dmsd",
      ".dmsd3d",
      ".dmsm",
      ".dmsm3d",
      ".dmss",
      ".dmx",
      ".dnc",
      ".dpa",
      ".dpg",
      ".dream",
      ".dsy",
      ".dv",
      ".dv-avi",
      ".dv4",
      ".dvdmedia",
      ".dvr",
      ".dvr-ms",
      ".dvx",
      ".dxr",
      ".dzm",
      ".dzp",
      ".dzt",
      ".edl",
      ".evo",
      ".evo",
      ".exo",
      ".eye",
      ".eyetv",
      ".ezt",
      ".f4f",
      ".f4m",
      ".f4p",
      ".f4v",
      ".fbr",
      ".fbr",
      ".fbz",
      ".fcarch",
      ".fcp",
      ".fcproject",
      ".ffd",
      ".ffm",
      ".flc",
      ".flh",
      ".fli",
      ".flic",
      ".flv",
      ".flx",
      ".fpdx",
      ".ftc",
      ".fvt",
      ".g2m",
      ".g64",
      ".g64x",
      ".gcs",
      ".gfp",
      ".gifv",
      ".gl",
      ".gom",
      ".grasp",
      ".gts",
      ".gvi",
      ".gvp",
      ".gxf",
      ".h264",
      ".hdmov",
      ".hdv",
      ".hkm",
      ".ifo",
      ".imovielibrary",
      ".imoviemobile",
      ".imovieproj",
      ".imovieproject",
      ".inp",
      ".int",
      ".ircp",
      ".irf",
      ".ism",
      ".ismc",
      ".ismclip",
      ".ismv",
      ".iva",
      ".ivf",
      ".ivr",
      ".ivs",
      ".izz",
      ".izzy",
      ".jdr",
      ".jmv",
      ".jnr",
      ".jss",
      ".jts",
      ".jtv",
      ".k3g",
      ".kdenlive",
      ".kmv",
      ".ktn",
      ".lrec",
      ".lrv",
      ".lsf",
      ".lsx",
      ".lvix",
      ".m15",
      ".m1pg",
      ".m1v",
      ".m21",
      ".m21",
      ".m2a",
      ".m2p",
      ".m2t",
      ".m2ts",
      ".m2v",
      ".m4e",
      ".m4u",
      ".m4v",
      ".m75",
      ".mani",
      ".meta",
      ".mgv",
      ".mj2",
      ".mjp",
      ".mjpeg",
      ".mjpg",
      ".mk3d",
      ".mkv",
      ".mmv",
      ".mnv",
      ".mob",
      ".mod",
      ".modd",
      ".moff",
      ".moi",
      ".moov",
      ".mov",
      ".movie",
      ".movie",
      ".mp21",
      ".mp21",
      ".mp2v",
      ".mp4",
      ".mp4.infovid",
      ".mp4v",
      ".mpe",
      ".mpeg",
      ".mpeg1",
      ".mpeg2",
      ".mpeg4",
      ".mpf",
      ".mpg",
      ".mpg2",
      ".mpg4",
      ".mpgindex",
      ".mpl",
      ".mpl",
      ".mpls",
      ".mproj",
      ".mpsub",
      ".mpv",
      ".mpv2",
      ".mqv",
      ".msdvd",
      ".mse",
      ".msh",
      ".mswmm",
      ".mt2s",
      ".mts",
      ".mtv",
      ".mvb",
      ".mvc",
      ".mvd",
      ".mve",
      ".mvex",
      ".mvp",
      ".mvp",
      ".mvy",
      ".mxf",
      ".mxv",
      ".mys",
      ".n3r",
      ".ncor",
      ".nfv",
      ".nsv",
      ".ntp",
      ".nut",
      ".nuv",
      ".nvc",
      ".ogm",
      ".ogv",
      ".ogx",
      ".orv",
      ".osp",
      ".otrkey",
      ".pac",
      ".par",
      ".pds",
      ".pgi",
      ".photoshow",
      ".piv",
      ".pjs",
      ".playlist",
      ".plproj",
      ".pmf",
      ".pmv",
      ".pns",
      ".ppj",
      ".prel",
      ".pro",
      ".pro4dvd",
      ".pro5dvd",
      ".proqc",
      ".prproj",
      ".prtl",
      ".psb",
      ".psh",
      ".pssd",
      ".psv",
      ".pva",
      ".pvr",
      ".pxv",
      ".pz",
      ".qt",
      ".qtch",
      ".qtindex",
      ".qtl",
      ".qtm",
      ".qtz",
      ".r3d",
      ".rcd",
      ".rcproject",
      ".rcrec",
      ".rcut",
      ".rdb",
      ".rec",
      ".rm",
      ".rmd",
      ".rmd",
      ".rmp",
      ".rms",
      ".rmv",
      ".rmvb",
      ".roq",
      ".rp",
      ".rsx",
      ".rts",
      ".rts",
      ".rum",
      ".rv",
      ".rvid",
      ".rvl",
      ".san",
      ".sbk",
      ".sbt",
      ".sbz",
      ".scc",
      ".scm",
      ".scm",
      ".scn",
      ".screenflow",
      ".sdv",
      ".sec",
      ".sec",
      ".sedprj",
      ".seq",
      ".sfd",
      ".sfera",
      ".sfvidcap",
      ".siv",
      ".smi",
      ".smi",
      ".smil",
      ".smk",
      ".sml",
      ".smv",
      ".snagproj",
      ".spl",
      ".sqz",
      ".srt",
      ".ssf",
      ".ssm",
      ".stl",
      ".str",
      ".stx",
      ".svi",
      ".swf",
      ".swi",
      ".swt",
      ".tda3mt",
      ".tdt",
      ".tdx",
      ".theater",
      ".thp",
      ".tid",
      ".tivo",
      ".tix",
      ".tod",
      ".tp",
      ".tp0",
      ".tpd",
      ".tpr",
      ".trec",
      ".trp",
      ".ts",
      ".tsp",
      ".ttxt",
      ".tvlayer",
      ".tvrecording",
      ".tvs",
      ".tvshow",
      ".usf",
      ".usm",
      ".v264",
      ".vbc",
      ".vc1",
      ".vcpf",
      ".vcr",
      ".vcv",
      ".vdo",
      ".vdr",
      ".vdx",
      ".veg",
      ".vem",
      ".vep",
      ".vf",
      ".vft",
      ".vfw",
      ".vfz",
      ".vgz",
      ".vid",
      ".video",
      ".viewlet",
      ".viv",
      ".vivo",
      ".vix",
      ".vlab",
      ".vmlf",
      ".vmlt",
      ".vob",
      ".vp3",
      ".vp6",
      ".vp7",
      ".vpj",
      ".vr",
      ".vro",
      ".vs4",
      ".vse",
      ".vsp",
      ".vtt",
      ".w32",
      ".wcp",
      ".webm",
      ".wfsp",
      ".wgi",
      ".wlmp",
      ".wm",
      ".wmd",
      ".wmmp",
      ".wmv",
      ".wmx",
      ".wot",
      ".wp3",
      ".wpl",
      ".wsve",
      ".wtv",
      ".wve",
      ".wvm",
      ".wvx",
      ".wxp",
      ".xej",
      ".xel",
      ".xesc",
      ".xfl",
      ".xlmv",
      ".xml",
      ".xmv",
      ".xvid",
      ".y4m",
      ".yog",
      ".yuv",
      ".zeg",
      ".zm1",
      ".zm2",
      ".zm3",
      ".zmv"
    };

    #endregion

    public Importer(PlexArgs args) {
      _args = args;
    }

    public void Process() {
      using (var sw = new StreamWriter($@"{_args.Log}\{DateTime.Now:MM-dd-yyyy}.log")) {

      }

//      var sourceFiles = Directory.GetFiles(_args.Source);
//
//      ProcessFiles(sourceFiles);

//      var sourceFolders = Directory.GetDirectories(_args.Source);
//      var targetFolders = Directory.GetDirectories(_args.Target);

//      ProcessFolders(sourceFolders, targetFolders);
    }

    private void ProcessFolder(string folder) {
      var folders = Directory.GetDirectories(folder);

      foreach (var f in folders) {
        ProcessFolder(f);
      }
      
      var groups = 
        Directory
          .GetFiles(folder)
          .GroupBy(Path.GetFileNameWithoutExtension)
          .Select(x => new {Name = x.Key, Files = x});

      foreach (var group in groups) {
        var isFileValid = false;
        var targetDirectory = string.Empty;

        foreach (var file in group.Files) {
          var extension = Path.GetExtension(file);

          if (_audioExtensions.Contains(extension)) {
            isFileValid = true;
            targetDirectory = $@"{_args.Target}\Music";
          }
          else if (_videoExtensions.Contains(extension)) {
            isFileValid = true;
            targetDirectory =  $@"{_args.Target}\Movies";
          }
        }

        if (!isFileValid) {
          continue;
        }
        
        var files = Directory.EnumerateFiles(folder, $"{group.Name}.*");
        var newFolders = folder.Replace(_args.Source, string.Empty);
        targetDirectory = Path.Combine(targetDirectory, newFolders);

        ProcessFiles(targetDirectory, files);
      }
    }

    private void ProcessFiles(string newDirectory, IEnumerable<string> files) {
      
    }

    private void ProcessFiles(IEnumerable<string> files) {
      using (var sw = new StreamWriter($@"{_args.Log}\{DateTime.Now:MM-dd-yyyy}.log")) {
        foreach (var file in files) {
          var fileName = Path.GetFileName(file);
          var extension = Path.GetExtension(file).ToLower();
          string targetDirectory;

          if (_audioExtensions.Contains(extension)) {
            targetDirectory = $@"{_args.Target}\Music";
          }
          else if (_videoExtensions.Contains(extension)) {
            targetDirectory =  $@"{_args.Target}\Movies";
          }
          else {
            var f = Path.GetFileNameWithoutExtension(file);
            continue;
          }

          var targetFile = $@"{targetDirectory}\{fileName}";

          if (!Directory.Exists(targetDirectory)) {
            Directory.CreateDirectory(targetDirectory);
          }
          
          if (File.Exists(targetFile)) {
            continue;
          }

          File.Copy(file, targetFile);
          
          sw.WriteLine($"SUCCESS: {file} successfully copied to {targetFile}");
        }
      }
    }
  }
}